package com.synergisticit.service;

import java.util.Arrays;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import com.synergisticit.model.Employee;
import com.synergisticit.model.Status;
import com.synergisticit.model.Ticket;

@Service
public class TicketService {
	
		@Autowired
		private RestTemplate restTemplate;
		
	    @Value("${ticket.service.url}") 
	    private String ticketServiceUrl;

	    public Ticket createTicket(Ticket ticket) {
	    	
	    	String url = ticketServiceUrl + "/api/tickets";
	    	
            return restTemplate.postForEntity(url, ticket, Ticket.class).getBody();	
	    }
	    
	    public Ticket findById(Long id) {
	    	String url = ticketServiceUrl + "/api/tickets/" + id;
	    	
	    	return restTemplate.getForObject(url, Ticket.class);
	    }
	    
	    public List<Ticket> getTicketByStatus(Status status) {
	    	
	    	String url = ticketServiceUrl + "/api/tickets?status=" + status.name();
	    	
	    	Ticket[] tickets = restTemplate.getForObject(url, Ticket[].class);
	    	
	        return Arrays.asList(tickets);
	    }
	    
	    public List<Ticket> findByCreatedBy_Id(Long creatorId ) {
	    	
	    	String url = ticketServiceUrl + "/api/tickets/createdBy/" + creatorId;
	    	Ticket[] tickets = restTemplate.getForObject(url, Ticket[].class);
	    	
	    	return Arrays.asList(tickets);
	    }
	    
	    public Ticket updateTicket(Long id, Ticket ticket) {
	        String url = ticketServiceUrl + "/api/tickets/" + id;

	        HttpEntity<Ticket> requestEntity = new HttpEntity<>(ticket);

	        ResponseEntity<Ticket> response = restTemplate.exchange(
	            url, 
	            HttpMethod.PUT, 
	            requestEntity, 
	            Ticket.class
	        );

	        return response.getBody();
	    }
	    
	    public Ticket approveTicket(Long id, Ticket ticket, String comment) {

	        String url = UriComponentsBuilder
	                .fromUriString(ticketServiceUrl + "/api/tickets/" + id + "/approve")
	                .queryParam("comment", comment)
	                .toUriString();

	        HttpEntity<Ticket> requestEntity = new HttpEntity<>(ticket);

	        ResponseEntity<Ticket> response = restTemplate.exchange(
	                url,
	                HttpMethod.PUT,
	                requestEntity,
	                Ticket.class
	        );

	        return response.getBody();
	    }
	    
	    public Ticket rejectTicket(Long id, Ticket ticket, String comment) {

	        String url = UriComponentsBuilder
	                .fromUriString(ticketServiceUrl + "/api/tickets/" + id + "/reject")
	                .queryParam("comment", comment)
	                .toUriString();

	        HttpEntity<Ticket> requestEntity = new HttpEntity<>(ticket);

	        ResponseEntity<Ticket> response = restTemplate.exchange(
	                url,
	                HttpMethod.PUT,
	                requestEntity,
	                Ticket.class
	        );

	        return response.getBody();
	    }
	    
	    public Ticket assignTicket(Long assignerId, Ticket ticket, String comment) {
	        String url = UriComponentsBuilder
	                .fromUriString(ticketServiceUrl + "/api/tickets/" + assignerId + "/assign")
	                .queryParam("comment", comment)
	                .toUriString();

	        HttpEntity<Ticket> requestEntity = new HttpEntity<>(ticket);

	        ResponseEntity<Ticket> response = restTemplate.exchange(
	                url,
	                HttpMethod.PUT,
	                requestEntity,
	                Ticket.class
	        );

	        return response.getBody();
	    }
	    
	    public Ticket resolveTicket(Long resolverId, Ticket ticket, String comment) {
	    	String url = UriComponentsBuilder
	                .fromUriString(ticketServiceUrl + "/api/tickets/" + resolverId + "/resolve")
	                .queryParam("comment", comment)
	                .toUriString();

	        HttpEntity<Ticket> requestEntity = new HttpEntity<>(ticket);

	        ResponseEntity<Ticket> response = restTemplate.exchange(
	                url,
	                HttpMethod.PUT,
	                requestEntity,
	                Ticket.class
	        );

	        return response.getBody();
	    }
	    
	    public Ticket reopenTicket(Long reopenerId, Ticket ticket, String comment) {
	    	String url = UriComponentsBuilder
	                .fromUriString(ticketServiceUrl + "/api/tickets/" + reopenerId + "/reopen")
	                .queryParam("comment", comment)
	                .toUriString();

	        HttpEntity<Ticket> requestEntity = new HttpEntity<>(ticket);

	        ResponseEntity<Ticket> response = restTemplate.exchange(
	                url,
	                HttpMethod.PUT,
	                requestEntity,
	                Ticket.class
	        );

	        return response.getBody();
	    }
}	
/*
 *     @PutMapping("/{id}")
    public ResponseEntity<Ticket> updateTicket(@PathVariable Long id, @RequestBody Ticket ticket) {
        Ticket updatedTicket = ticketService.update(id, ticket);
        return ResponseEntity.ok(updatedTicket);
    }
 */