package com.synergisticit.service;

import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jms.annotation.JmsListener;
import org.springframework.stereotype.Service;

import com.synergisticit.domain.Ticket;

import tools.jackson.core.type.TypeReference;
import tools.jackson.databind.ObjectMapper;


@Service
public class TicketListener {
	private final ObjectMapper objectMapper;
	
	@Autowired
	EmailService emailService;
	
	public TicketListener(ObjectMapper objectMapper) {
		this.objectMapper = objectMapper;
	}
	@JmsListener(destination = "ticket.created")
	public void receiveTicketCreated(String ticketJson) {
	    Map<String, String> ticketMap = objectMapper.readValue(ticketJson, new TypeReference<Map<String, String>>() {});

	    String ticketId = String.valueOf(ticketMap.get("id"));
	    String title = String.valueOf(ticketMap.get("title"));
	    String description = String.valueOf(ticketMap.get("description"));
	    String createdBy = String.valueOf(ticketMap.get("createdByEmail"));
	    String createdDate = String.valueOf(ticketMap.get("createdDate"));
	    String managerEmail = String.valueOf(ticketMap.get("managerEmail"));
	    String emailBody = """
	            Dear Manager,

	            A new ticket has been created in the system.

	            Ticket Details:
	            ------------------------
	            Ticket ID      : %s
	            Title          : %s
	            Description    : %s
	            Created By     : %s
	            Created Date   : %s
	            ------------------------

	            Please review and take the necessary actions.

	            Best regards,
	            IT Support Team
	            """.formatted(ticketId, title, description, createdBy, createdDate);

	    //Send Email to manager
	    emailService.sendSimpleEmail(ticketMap.get("managerEmail"), emailBody,ticketMap.get("createdByEmail"));
	}
}
