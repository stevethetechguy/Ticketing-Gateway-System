<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
    <title>Manager Approvals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
<%@ include file="navbar.jsp" %>

<div class="container mt-5">
    <h2 class="mb-4">Pending Ticket Approvals</h2>
    
    <div class="table-responsive bg-white shadow-sm p-3 rounded">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Priority</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <c:forEach items="${pendingTickets}" var="ticket">
                    <tr id="row-${ticket.id}">
                        <td>${ticket.id}</td>
                        <td>${ticket.title}</td>
                        <td>${ticket.description}</td>
                        <td><span class="badge bg-info">${ticket.category}</span></td>
                        <td>${ticket.priority}</td>
                        <td>
							<button class="btn btn-success btn-sm" onclick="openDecisionModal(${ticket.id}, 'APPROVED')">
							    Approve
							</button>
							<button class="btn btn-danger btn-sm" onclick="openDecisionModal(${ticket.id}, 'REJECTED')">
							    Reject
							</button>
                        </td>
                    </tr>
                </c:forEach>
            </tbody>
        </table>
    </div>
</div>

<div class="modal" id="decisionModal" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="modalHeader" class="modal-header text-white">
                <h5 class="modal-title" id="decisionTitle">Confirm Action</h5>
                <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentTicketId">
                <input type="hidden" id="currentStatus">
                <div class="mb-3">
                    <label class="form-label">Manager Comments:</label>
                    <textarea id="decisionReason" class="form-control" rows="3" placeholder="Enter reason here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" id="confirmBtn" class="btn" onclick="submitDecision()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
function openDecisionModal(id, status) {
        $("#currentTicketId").val(id);
        $("#currentStatus").val(status);
        $("#decisionReason").val(""); 

        if (status === 'APPROVED') {
            $("#decisionTitle").text("Approve Ticket #" + id);
            $("#modalHeader").removeClass("bg-danger").addClass("bg-success");
            $("#confirmBtn").removeClass("btn-danger").addClass("btn-success").text("Confirm Approval");
        } else {
            $("#decisionTitle").text("Reject Ticket #" + id);
            $("#modalHeader").removeClass("bg-success").addClass("bg-danger");
            $("#confirmBtn").removeClass("btn-success").addClass("btn-danger").text("Confirm Rejection");
        }

        // Using jQuery to show the modal manually
        $("#decisionModal").show();
    }

    // 2. Hide Modal
    function closeModal() {
        $("#decisionModal").hide();
    }
	function submitDecision(id, status) {
		var id = $("#currentTicketId").val();
        var status = $("#currentStatus").val();
        var comment = $("#decisionReason").val();

        // Object matches your Ticket entity structure
        var formData = {
            "id": id,
            "status": status,
            "comment": comment 
        };
			console.log(id);
			console.log(status);
			console.log(comment);
			 $.ajax({
			        url: "${pageContext.request.contextPath}/updateTicketStatus",
			        type: "PUT",
			        data: formData,
			        processData: false,  // Tell jQuery not to process the data
			        contentType: false,  // Tell jQuery not to set contentType (FormData does this)
			        success: function(response) {
			            alert("Success: " + response);
			            window.location.href = "${pageContext.request.contextPath}/home";
			        },
			        error: function(xhr, status, error) {
			            alert("Error: " + xhr.responseText);
			            console.log(error);
			        }
			    });
        }
			    
			
</script>
</body>
</html>